<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app/watches/proxy/shell.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app/watches/proxy/shell.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var HAProxyTemplate = require('./HAProxyTemplate.js');

/** @module app/watches/proxy/shell */

module.exports = {
	/**
	* Generate a template of routing configurations for HAProxy
	* @param {Context} context - Context instance
	* @param {array} pairs - An array of pair objects. Currently not defined
	* @param {array} manticores - An array of service objects, returned by Consul's service watches
	* @returns {HAProxyTemplate} - A template of routing configurations 
	*/
	generateProxyData: function (context, pairs, manticores) {
		//for each pair, extract connection information and add them to HAProxy config file
		//put TCP blocks in a separate file
		var file = HAProxyTemplate();
		file.setMainPort(process.env.HAPROXY_HTTP_LISTEN);

		for (let i = 0; i &lt; manticores.length; i++) {
			var manticore = manticores[i];
			file.addWebAppAddress(manticore.Address + ":" + manticore.Port);
		}

		//generate a number of unique ports equal to the number of pairs
		//add the routes routes
		for (let i = 0; i &lt; pairs.length; i++) {
			//generate a random port number in a range specified by environment variables
			//to pick as an exposed port for a TCP connection
			let pair = pairs[i];

			file.addHttpRoute(pair.userAddressExternal, pair.userAddressInternal)
				.addHttpRoute(pair.hmiAddressExternal, pair.hmiAddressInternal)
				.addHttpRoute(pair.brokerAddressExternal, pair.brokerAddressInternal)
				.addTcpRoute(pair.tcpPortExternal, pair.tcpAddressInternal)
		}
		return file;
	},
	/**
	* Updates the KV store with new information from a template for core/hmi routing
	* @param {Context} context - Context instance
	* @param {HAProxyTemplate} template - Template storing routing configurations
	*/
	updateCoreHmiKvStore: function (context, template) {
		//use the HAProxyTemplate file to submit information to the KV store so that
		//consul-template can use that information to generate an HAProxy configuration
		//replace everything under haproxy/data, which includes http and tcp mappings
		context.consuler.delKeyAll(context.keys.data.haproxy, function () {
			for (let i = 0; i &lt; template.tcpMaps.length; i++) {
				let item = template.tcpMaps[i];
				context.consuler.setKeyValue(context.keys.haproxy.tcpMaps + "/" + item.port, item.to, function (){});
			}	
			for (let i = 0; i &lt; template.httpMaps.length; i++) {
				let item = template.httpMaps[i];
				context.consuler.setKeyValue(context.keys.haproxy.httpFront + "/" + i, item.from, function (){});
				context.consuler.setKeyValue(context.keys.haproxy.httpBack + "/" + i, item.to, function (){});
			}	
		});
	},
	/**
	* Updates the KV store with new information from a template for Manticore routing
	* @param {Context} context - Context instance
	* @param {HAProxyTemplate} template - Template storing routing configurations
	*/
	updateManticoreKvStore: function (context, template) {
		//only update manticore web app addresses!
		//reset only web app addresses!
		context.consuler.delKeyAll(context.keys.haproxy.webApp, function () {
			for (let i = 0; i &lt; template.webAppAddresses.length; i++) {
				let item = template.webAppAddresses[i];
				context.consuler.setKeyValue(context.keys.haproxy.webApp + "/" + i, item, function () {});
			}				
		});
	}
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-app_controller.html">app/controller</a></li><li><a href="module-app_controller-logic.html">app/controller-logic</a></li><li><a href="module-app_requestCore_core.html">app/requestCore/core</a></li><li><a href="module-app_requestCore_shell.html">app/requestCore/shell</a></li><li><a href="module-app_requestLogs_core.html">app/requestLogs/core</a></li><li><a href="module-app_requestLogs_shell.html">app/requestLogs/shell</a></li><li><a href="module-app_watches_core.html">app/watches/core</a></li><li><a href="module-app_watches_job_core.html">app/watches/job/core</a></li><li><a href="module-app_watches_job_shell.html">app/watches/job/shell</a></li><li><a href="module-app_watches_proxy_shell.html">app/watches/proxy/shell</a></li><li><a href="module-app_watches_shell.html">app/watches/shell</a></li></ul><h3>Classes</h3><ul><li><a href="AllocationData.html">AllocationData</a></li><li><a href="AwsHandler.html">AwsHandler</a></li><li><a href="ConnectionSocket.html">ConnectionSocket</a></li><li><a href="Context.html">Context</a></li><li><a href="HAProxyTemplate.html">HAProxyTemplate</a></li><li><a href="Listener.html">Listener</a></li><li><a href="SocketHandler.html">SocketHandler</a></li><li><a href="UserRequest.html">UserRequest</a></li><li><a href="WaitingList.html">WaitingList</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Wed Mar 08 2017 10:04:35 GMT-0500 (EST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
